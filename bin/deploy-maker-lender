#!/usr/bin/env bash
set -ex

BIN_DIR=${BIN_DIR:-$(cd "${0%/*}"&&pwd)}
ADDRESS_DIR=${ADDRESS_DIR:-$PWD/out/address}
mkdir -p $ADDRESS_DIR 

export ETH_GAS=${ETH_GAS:-"7000000"}
export ETH_FROM=${ETH_FROM:-$(seth rpc eth_coinbase)}
export SOLC_FLAGS="--optimize"

test -z "$SKIP_BUILD" && dapp build

# Set god address to 0 if not defined
test -z "$GOD_ADDR" && GOD_ADDR="0x00000000000000000000"

LENDER_FAB=$(dapp create MakerLenderFab $MCD_DEPLOY $MCD_PROXY $CDP_MANAGER)
$(seth send $DEPLOYER 'deployLender(address, address)' $CURRENCY $LENDER_FAB)
LENDER=0x$(seth call $DEPLOYER 'lender()(address)')
$(seth send $LENDER 'file(bytes32, address)' "$(seth --to-bytes32 $(echo "gemJoin")"

cat > "$ADDRESS_DIR/load-maker-lender-$(seth chain)" << EOF
#!/bin/bash
# lender fab deployment on $(seth chain) from $(git rev-parse HEAD)
# $(date)
export LENDER_FAB=$LENDER_FAB
export LENDER=$LENDER
EOF
